<!DOCTYPE html>
<html lang="en">
<head>
    <title>Prebid PubLink ID Module Test Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <script async src="//www.googletagservices.com/tag/js/gpt.js"></script>
    <script async src="../js/prebid-5.20.0.js"></script>

    <script src="https://secure.cdn.fastclick.net/js/cnvr-launcher/latest/launcher-stub.min.js"></script>

    <script>conversant.launch('launcher', 'loadConfig', 684)</script>

    <script>
        var PREBID_TIMEOUT = 2000;
        var FAILSAFE_TIMEOUT = 3000;

        var adUnits = [{
            code: "MedRect",
            mediaTypes: { banner: { sizes: [ [300, 250] ] } },
            bids: [
                { bidder: "openx", params: { unit: "540096529", delDomain: "sademo-d.openx.net" } },
                { bidder: "appnexus", params: { placementId: 13144370 } },
                { bidder: "conversant", params: { site_id: '108060' } }
            ]
        }, {
            code: "Leaderboard",
            mediaTypes: { banner: { sizes: [ [728, 90] ] } },
            bids: [
                { bidder: "openx", params: { unit: "540096529", delDomain: "sademo-d.openx.net" } },
                { bidder: "appnexus", params: { placementId: 13144370 } },
                { bidder: "conversant", params: { site_id: '108060' } }
            ]
        }];

        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
        googletag.cmd.push(function() {
            googletag.pubads().disableInitialLoad();
        });

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        pbjs.bidderSettings = {
            conversant: {
                bidCpmAdjustment : function(bidCpm) { return bidCpm * 100; }
            }
        };

        pbjs.que.push(function() {
            pbjs.setConfig({
                userSync: {
                    userIds: [{
                        name: "publinkId",
                        storage: {
                            type: "cookie",
                            name: "pbjs_publink",
                            expires: 30
                        }
                    }],
                    syncDelay: 3000
                }
            });
            pbjs.onEvent('auctionEnd', function() {pbjs.initAdserverSet = false;updateBidTable();});
            pbjs.addAdUnits(adUnits);
            pbjs.requestBids({
                bidsBackHandler: initAdserver,
                timeout: PREBID_TIMEOUT
            });
        });

        function initAdserver() {
            if (pbjs.initAdserverSet) return;
            pbjs.initAdserverSet = true;
            googletag.cmd.push(function() {
                pbjs.que.push(function() {
                    pbjs.setTargetingForGPTAsync();
                    googletag.pubads().refresh();
                });
            });
        }
        // in case PBJS doesn't load
        setTimeout(function() {
            initAdserver();
        }, FAILSAFE_TIMEOUT);

        googletag.cmd.push(function() {
            googletag.defineSlot('/19968336/header-bid-tag-0',  [[300, 250],[300,600]], 'MedRect').addService(googletag.pubads());
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
        googletag.cmd.push(function() {
            googletag.defineSlot('/19968336/header-bid-tag-1',  [[728, 90]], 'Leaderboard').addService(googletag.pubads());
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });

    </script>
</head>
<body>
<script>
    function getCookie(name) {
        if (name && window.document.cookie) {
            const m = window.document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]*)\\s*(;|$)');
            return m ? decodeURIComponent(m[2]) : null;
        }
        return null;
    }

    function collectBidInfo() {
        function forEach(responses, cb) {
            Object.keys(responses).forEach(function(adUnitCode) {
                const response = responses[adUnitCode];
                response.bids.forEach(function(bid) {
                    cb(adUnitCode, bid);
                });
            });
        }

        const output = [];
        forEach(pbjs.getBidResponses(), function(code, bid) {
            output.push({
                adunit: code,
                bidder: bid.bidder,
                cpm: bid.cpm,
                time: bid.timeToRespond
            });
        });
        forEach(pbjs.getNoBids && pbjs.getNoBids() || {}, function(code, bid) {
            output.push({
                adunit: code,
                bidder: bid.bidder,
                cpm: null,
                time: bid.timeToRespond
            });
        });

        return output;
    }

    function compareBids(a, b) {
        const fields = ['adunit', 'bidder', 'cpm'];
        let rc = 0;
        for (let i = 0; i < fields.length; ++i) {
            if (rc !== 0) break;
            if (a[fields[i]] > b[fields[i]])
                rc = 1;
            else if (a[fields[i]] < b[fields[i]])
                rc = -1;
        }
        return rc;
    }

    function updateBidTable() {
        const oldBody = document.getElementById('bidtable').getElementsByTagName('tbody')[0];
        const newBody = document.createElement('tbody');

        const bidInfo = collectBidInfo();
        bidInfo.sort(compareBids);
        for (let i = 0; i < bidInfo.length; ++i) {
            const row = newBody.insertRow();
            row.insertCell().appendChild(document.createTextNode(bidInfo[i].adunit));
            row.insertCell().appendChild(document.createTextNode(bidInfo[i].bidder));
            row.insertCell().appendChild(document.createTextNode(bidInfo[i].time ? bidInfo[i].time : ''));
            row.insertCell().appendChild(document.createTextNode(bidInfo[i].cpm ? bidInfo[i].cpm : ''));
        }

        oldBody.parentNode.replaceChild(newBody, oldBody);
    }

    function processForm() {
        const email = document.getElementById('email').value;

        if (email) {
            pbjs.que.push(function() {
                window.conversant.launch('publink', 'start', {email: email, apiKey: '538713cd-e681-4779-87ce-35d2574dea66'})
            });
        }
    }

    window.onload = function() {
        // Check and display cookie values at fixed interval
        const pbjs_publink_node = document.getElementById('pbjs_publink_value');
        const publink_node = document.getElementById('publink_value');
        const publink_srv_node = document.getElementById('publink_srv_value');

        function checkValues() {
            const pbjs_publink_value = getCookie('pbjs_publink');
            const publink_value = getCookie('_publink');
            const publink_srv_value = getCookie('_publink_srv');

            pbjs_publink_node.innerText = pbjs_publink_value;
            publink_node.innerText = publink_value;
            publink_srv_node.innerText = publink_srv_value;
        }

        setInterval(checkValues, 2000);
    }
</script>
<div class="container-md">
    <div class="row">
        <div id="Leaderboard" class="col mb-2 d-flex justify-content-center" style="height: 90px">
            <script type='text/javascript'>
                googletag.cmd.push(function() {
                    googletag.display('Leaderboard');
                });
            </script>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col">
            <form id="reg_form" action="javascript:processForm()" class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title text-center">PubLink v2 Coreid.js Test Form</h5>
                    <div class="text-center">Retrieve encrypted PubLink ID using coreid.js</div>
                    <hr/>
                    <div>
                        <div class="form-group row">
                            <label for="email" class="col-form-label col-sm-2">Email</label>
                            <div class="col-sm-10">
                                <input type="email" placeholder="Enter Email Address" name="email" id="email" class="form-control">
                            </div>
                        </div>
                        <div class="form-group mt-3">
                            <input type="submit" value="Register" class="btn btn-primary">
                            <input type="button" value="Clear Form" class="btn btn-secondary" onclick="document.getElementById('reg_form').reset()">
                            <input type="button" value="Bid" class="btn btn-secondary" onclick="pbjs.que.push(
                            function() {
                                pbjs.requestBids({
                                bidsBackHandler: initAdserver,
                                timeout: PREBID_TIMEOUT
                            })})">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-center">Cookies</h5>
                    <table class="table">
                        <thead>
                        <tr><th scope="col">Name</th><th scope="col">Value</th></tr>
                        </thead>
                        <tbody>
                        <tr><th scope="row">pbjs_publink</th><td><span id="pbjs_publink_value" class="text-break text-monospace"></span></td></tr>
                        <tr><th scope="row">_publink</th><td><span id="publink_value" class="text-break text-monospace"></span></td></tr>
                        <tr><th scope="row">_publink_srv</th><td><span id="publink_srv_value" class="text-break text-monospace"></span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">

        <div class="col">
            <div class="card">
                <div class="card-body">
                    <table class="table" id="bidtable">
                        <thead>
                        <tr><th>AdUnit</th><th>Bidder</th><th>Time</th><th>CPM</th></tr>
                        </thead>
                        <tbody>
                            <!-- to be filled in by javascript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col">
            <div id="MedRect">
                <script type="text/javascript">
                    googletag.cmd.push(function() {
                        googletag.display('MedRect');
                    });
                </script>
            </div>
        </div>
    </div>
</div>

</body>
</html>
