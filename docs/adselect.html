<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Ad Select - Mobile</title>
    <style>
        body {
            margin: 0;
            padding: 0
        }

        #main {
            margin-top: 50px;
            text-align: center
        }

        .radio {
            left: 45%;
            margin: auto;
            position: relative;
            text-align: left
        }
    </style>
    <script src="adv_mrc/mobile/qrcode.js"></script>
    <script>
        function generateQR() {
            let requestURL, siteID, dealID, width, height, type, dvcid, ip,
                bannerURL = 'https://ssapi.ad.cpe.dotomi.com/cvx/server/ssapi/lite',
                typeNumber = 0,
                errorCorrectionLevel = 'L',
                qr = qrcode(typeNumber, errorCorrectionLevel),
                qrDiv = document.getElementById('qrcode'),
                dropdownAdSize = document.getElementById("ad-select"),
                dropdownSite = document.getElementById("site-select"),
                selectedAd = dropdownAdSize.selectedIndex,
                selectedSite = dropdownSite.selectedIndex,
                adType = (selectedAd < 5 && selectedAd !=7) ? "banner" : (selectedAd < 7) ? "video" : "audio",
                size = dropdownAdSize.options[dropdownAdSize.selectedIndex].value,
                site = dropdownSite.options[dropdownSite.selectedIndex].value,
                videoDomain = 'mobilevideo.html',
                userAgent = encodeURIComponent(document.getElementById('raw_user_agent').value),
                main = document.getElementById('main');
                qrDiv.style.marginTop = "30px";

            // function generateVideoRequest() {
            //     let location = window.location.href;
            //     let locationParts = location.split('/');
            //     let uri = "";
            //     for (i = 0; i < locationParts.length - 1; i++) {
            //         uri += locationParts[i] + "/";
            //     }

            //     if (document.getElementById('dtype_i').checked){
            //         uri+= '/platform/'
            //         console.log("checked");
            //     }
            //     uri += videoDomain;

            //     return uri
            //         + '?sid=125684&deal_id=213&bundle_id=com.conversant.test&limit_tracking=0&partner_version=3.0.6&partner_id=35001&gdpr=0&mimes=video/mp4'
            //         + '&w=' + width
            //         + '&h=' + height
            //         + '&ad_type=' + adType
            //         + '&device_id=' + dvcid
            //         + '&device_id_type=' + type
            //         + '&ip=' + ip
            //         + '&ua=' + userAgent;
            // };

            // function generateAudioRequest() {
            //     let location = window.location.href;
            //     let locationParts = location.split('/');
            //     let uri = "";
            //     for (i = 0; i < locationParts.length - 1; i++) {
            //         uri += locationParts[i] + "/";
            //     }

            //     // if (document.getElementById('dtype_i').checked){
            //     uri+= '/platform/'
            //     //     console.log("checked");
            //     // }
            //     uri += 'mobileaudio.html';

            //     return uri
            //         + '?sid=125684&deal_id=213&bundle_id=com.conversant.test&limit_tracking=0&partner_version=3.0.6&partner_id=35001&gdpr=0&mimes=audio/mp3'
            //         + '&w=' + width
            //         + '&h=' + height
            //         + '&ad_type=' + adType
            //         + '&device_id=' + dvcid
            //         + '&device_id_type=' + type
            //         + '&ip=' + ip
            //         + '&ua=' + userAgent
            //         + '&width=' + width
            //         + '&height=' + height;
            // };

            function generateBannerRequest() {

                return bannerURL
                    + '?sid=' + siteID
                    + '&deal_id=' + dealID
                    + '&bundle_id=com.conversant.test&limit_tracking=0&partner_version=3.0.6&api=5'
                    + '&w=' + width
                    + '&h=' + height
                    + '&ad_type=' + adType
                    + '&device_id=' + dvcid
                    + '&device_id_type=' + type
                    + '&ip=' + ip
                    + '&ua=' + userAgent
                    + '&width=' + width
                    + '&height=' + height;
            };

            switch (size) {
                case "Small Banner":
                    width = 320;
                    height = 50;
                    break;
                case "Medium Rectangle":
                    width = 300;
                    height = 250;
                    break;
                case "Interstitial":
                    width = 300;
                    height = 600;
                    break;
                case "Video AutoPlay":
                    width = 600;
                    height = 480;
                    videoDomain = 'mobilevideo.html';
                    break;
                case "Video Click-to-Play":
                    width = 600;
                    height = 480;
                    videoDomain = 'mobilevideo_ctp.html';
                    break;
                case "Audio":
                    width = 600;
                    height = 40;
                    break;
            }

            switch (site) {
                case "site_1":
                    siteID = 38799;
                    dealID = 120;
                    break;
                case "site_2":
                    siteID = 119041;
                    dealID = 170;
                    break;
                case "site_3":
                    siteID = 119042;
                    dealID = 171;
                    break;
                case "site_4":
                    siteID = 123889;
                    dealID = 211;
                    break;
                case "site_5":
                    siteID = 123890;
                    dealID = 212;
                    break;
                case "site_9":
                    siteID = 203416;
                    dealID = "10faf003-5";
                    break;
                case "site_10":
                    siteID = 203417;
                    dealID = "294b7104-e";
                    break;
                case "site_11":
                    siteID = 203418;
                    dealID = "ed6c2f0d-f";
                    break;
                case "site_12":
                    siteID = 203419;
                    dealID = "11a37245-9";
                    break;
            }

            if (document.getElementById('dtype_g').checked) {
                type = 'gaid';
            } else if (document.getElementById('dtype_i').checked) {
                type = 'idfa';
            }

            dvcid = document.getElementById('device_id').value;
            ip = document.getElementById('ip_address').value;



            if (adType === 'video') {
                requestURL = generateVideoRequest();
            } else if (adType === 'audio') {
                requestURL = generateAudioRequest();
            } else {
                requestURL = generateBannerRequest();
            }

            if (width && height && siteID && dealID && type && dvcid && ip) {
                if (!/^[0-9a-f]{8}-?[0-9a-f]{4}-?[1-5][0-9a-f]{3}-?[089ab][0-9a-f]{3}-?[0-9a-f]{12}$/i.test(dvcid)) {
                    qrDiv.innerHTML = "Please enter valid device id";
                    return;
                }

                if (!/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip)) {
                    qrDiv.innerHTML = "Please enter valid device IP address";
                    return;
                }

                if (!userAgent || /^\s*$/.test(userAgent)) {
                    qrDiv.innerHTML = "Please enter a unencoded user agent";
                    return;
                }

                console.log(` --- Selected ad format: ${adType}`);
                console.log(` --- Selected site: ${siteID}`);
                console.log(` --- Selected deal: ${dealID}`);
                console.log(` --- Selected ad type: ${size}`);
                console.log(` --- Size: ${width}x${height}`);
                console.log(` --- Request URI: ${requestURL}`);
                qr.addData(requestURL);
                qr.make();
                qrDiv.innerHTML = qr.createImgTag(4);
                
                device_type = (type == 'gaid' ) ? "google_play_id" : "idfa";
            
                var requestOptions = {
                method: 'GET'
                };

                fetch(`https://login.dotomi.com/syncEvent/?dtm_cid=80210&dtm_cmagic=6e9bba&dtm_fid=5404&dtm_reg_debug=true&dtm_user_ip=${ip}&${device_type}=${dvcid}&dtm_user_agent=${userAgent}`, requestOptions)
                .then(function(response) {
                    if (response.ok) {
                        return response.text();
                        } else {
                        throw new Error("Could not reach the API: " + response.statusText);
                    }
                }).then(function(result) {
                    syncMessageDiv = document.getElementById('syncmessage');
                    syncMessageDiv.innerHTML = "<h3>If using a new device ID, please allow ~15 minutes to for this to sync to a user profile.</h3>"
                
                }).catch(error => console.log('error', error));


            } else {
                qrDiv.innerHTML = "Please enter all required information";
            }
        }
    </script>
    <script>
        window.onload = function () {
            var ua = window.navigator.userAgent,
                anchorLocation = document.getElementById('install_anchor'),
                iOSUri = "itms-services://?action=download-manifest&url=https://demo.testmyads.com/adv_mrc/assets/beaker.plist",
                androidUri = "https://demo.testmyads.com/adv_mrc/assets/beaker.apk";

            function addInstallAnchor(installUri, text) {
                var anchor = document.createElement('a');
                anchor.innerHTML = text;
                anchor.href = installUri;
                anchorLocation.appendChild(anchor);
            }

            if (/.*(iPad|iPod|iPhone).*/i.test(ua)) {
                let text = "Install Beaker for iOS";
                addInstallAnchor(iOSUri, text);
                return;
            } else if (/.*(Android).*/i.test(ua)) {
                let text = "Install Beaker for Android";
                addInstallAnchor(androidUri, text);
                return;
            } else {
                addInstallAnchor("https://demo.testmyads.com/adv_mrc/assets/Beaker.ipa", "Download Beaker for iOS");
                var br = document.createElement("br");
                anchorLocation.appendChild(br);
                addInstallAnchor(androidUri, "Download Beaker for Android");

            }
        }
    </script>


</head>

<body>
    <div id='main'>
        <div>
            <div id='install_anchor'></div>
            <H3>Ad Select</H3>
            <select id="ad-select" name="ad-select">
                <option value="Small Banner" selected>Small Banner - 320x50</option>
                <option value="Medium Rectangle">Medium Rectangle 300x250</option>
                <option value="Interstitial">Interstitial - 300x600</option>
                <option value="Interstitial">Leaderboard - 728x90</option>
                <option value="Interstitial">Wide Skycraper - 160x600</option>
            </select>
        </div>
        <div>
            <H3>Select a Site </H3>
			<select id="site-select" name="site-select">
				<option></option>
				<option value="site_1">ADV US TestMyAds - SID:38799 - Deal:120</option>
				<option value="site_2">ADV US TestMyAds_1 - SID:119041 - Deal:170</option>
				<option value="site_3">ADV US TestMyAds_2 - SID:119042 - Deal:171</option>
				<option value="site_4">ADV UK/EU_TestMyAds_1 - SID:123889 - Deal:211</option>
				<option value="site_5">ADV UK/EU_TestMyAds_2 - SID:123890 - Deal:212</option>
				<option value="site_9">Access US TestMyAds_1 - SID:203416 - Deal:10faf003-5</option>
				<option value="site_10">Access US TestMyAds_2 - SID:203417 - Deal:294b7104-e</option>
				<option value="site_11">Access UK/EU_TestMyAds_1 - SID:203418 - Deal:ed6c2f0d-f</option>
				<option value="site_12">Access UK/EU_TestMyAds_2 - SID:203419 - Deal:11a37245-9</option>
			</select>
        </div>

        <div>
            <H3>Device Type</H3>
            <div class='radio'>
                <input id="dtype_g" type="radio" name="dtype" value="gaid">Android<br>
                <input id="dtype_i" type="radio" name="dtype" value="idfa" checked>iOS<br>
            </div>
            <div>
                <H3>Device ID</H3>
                <input type="text" id="device_id" style='height: 40px; width:300px'
                    placeholder="Ex: 068daabd-0121-4f3e-a801-44715b6a8133">
            </div>
            <div>
                <H3>IP Address</H3>
                <input type="text" id="ip_address" style='height: 20px; width:300px' placeholder="EX: 64.156.167.160">
            </div>
            <div>
                <H3>Unencoded User Agent</H3>
                <textarea id="raw_user_agent" style='height: 120px; width:320px'
                    placeholder="Ex: Mozilla/5.0 (Linux; Android 6.0.1; SM-G920V Build/MMB29K; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/50.0.2661.86 Mobile Safari/537.36"></textarea>
                <div>
                    <button style="margin-top: 20px" onclick="generateQR()">Generate QR</button>
                </div>
                <div id="syncmessage"></div>
                <div id="qrcode"></div>
            </div>
</body>

</html>